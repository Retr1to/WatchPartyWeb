<div class="room-container" *ngIf="room">
  <div class="room-header">
    <div class="room-info">
      <div class="room-code-display">
        <span class="room-icon"></span>
        <span class="room-code">{{ roomCode }}</span>
        <button class="copy-btn" (click)="copyRoomCode()" title="Copiar c贸digo de sala">ID</button>
        <button class="copy-btn" (click)="copyInviteLink()" title="Copiar enlace de invitaci贸n">
          
        </button>
      </div>
    </div>
    <div class="room-actions">
      <button
        class="device-btn"
        *ngIf="isHost() && videoUrl && videoProvider !== 'youtube'"
        [disabled]="!castStatus?.apiAvailable || !!castStatus?.isConnected"
        (click)="startCasting()"
        [title]="castStatus?.apiAvailable ? 'Enviar el video a una TV (Chromecast)' : 'Cast no disponible (requiere Chrome/Edge o que cargue el SDK)'"
      >
        Cast
      </button>

      <ng-container *ngIf="castStatus as cs">
        <ng-container *ngIf="cs.isConnected">
          <span class="device-status">
            Casting{{ cs.deviceName ? ' en ' + cs.deviceName : '' }}
          </span>
          <button class="device-btn device-btn-danger" (click)="stopCasting()">Desconectar</button>
        </ng-container>
      </ng-container>

      <button
        class="device-btn"
        *ngIf="isHost() && videoUrl && videoProvider !== 'youtube' && airplayStatus?.supported"
        (click)="showAirPlayPicker()"
        title="Enviar el video a una TV (AirPlay - Safari)"
      >
        AirPlay
      </button>

      <button class="exit-btn" (click)="leaveRoom()">
        Salir
      </button>
    </div>
  </div>

  <div class="room-content">
    <div class="video-section">
      <div class="video-container">
        <ng-container [ngSwitch]="videoProvider">
          <ng-container *ngSwitchCase="'youtube'">
            <div class="youtube-wrapper" *ngIf="videoUrl">
              <div #youtubePlayerContainer class="youtube-player"></div>
            </div>
          </ng-container>
          <ng-container *ngSwitchDefault>
            <video 
              #videoPlayer
              *ngIf="videoUrl"
              [src]="videoUrl"
              (play)="onPlay()"
              (pause)="onPause()"
              (seeking)="onSeeking()"
              (seeked)="onSeeked()"
              (timeupdate)="onTimeUpdate()"
              controls
              controlsList="nodownload"
              playsinline
              x-webkit-airplay="allow"
            ></video>
          </ng-container>
        </ng-container>
        
        <div class="video-placeholder" *ngIf="!videoUrl">
          <svg width="100" height="100" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <rect x="2" y="6" width="20" height="12" rx="2" stroke="white" stroke-width="2" fill="none"/>
            <circle cx="17" cy="12" r="2" fill="white"/>
          </svg>
          <p>Video en reproducci贸n</p>
        </div>
      </div>

      <div class="video-source-section">
        <div class="section-header">
          <span class="section-icon"></span>
          <span>Fuente de Video</span>
        </div>
        
        <input 
          #fileInput 
          type="file" 
          accept="video/mp4,video/webm,video/ogg,video/mov"
          (change)="onFileSelected($event)"
          style="display: none"
        />
        
        <div class="video-url-display" *ngIf="!isChangingVideo">
          <div class="current-url" *ngIf="videoUrl">
            <span class="url-text">{{ videoUrl }}</span>
          </div>
          <div class="no-url" *ngIf="!videoUrl">
            <span>No hay video seleccionado</span>
          </div>
          
          <div class="video-buttons" *ngIf="isHost()">
            <button class="btn btn-upload" (click)="fileInput.click()">
               Subir Video
            </button>
            <button class="btn btn-change" (click)="showVideoInput()">
               Pegar URL
            </button>
          </div>
          
          <div class="no-host-message" *ngIf="!isHost()">
            <span>Solo el anfitri贸n puede cargar videos</span>
          </div>
        </div>

        <div class="video-url-input" *ngIf="isChangingVideo">
          <input 
            type="text" 
            [(ngModel)]="newVideoUrl" 
            placeholder="Ingresa la URL del video (YouTube o enlace directo)"
            (keyup.enter)="changeVideo()"
          />
          <div class="input-buttons">
            <button class="btn btn-secondary" (click)="cancelVideoChange()">
              Cancelar
            </button>
            <button class="btn btn-primary" (click)="changeVideo()">
              Cargar Video
            </button>
          </div>
        </div>
      </div>
    </div>

    <div class="participants-section">
      <div class="section-header">
        <span class="section-icon"></span>
        <span>Participantes ({{ room.participants.length }})</span>
      </div>
      
      <div class="participants-list">
        <div 
          *ngFor="let participant of room.participants" 
          class="participant"
          [class.host]="participant.isHost"
        >
          <div class="participant-info">
            <span class="participant-name">{{ participant.username }}</span>
            <span class="participant-badge" *ngIf="participant.isHost">
              Anfitri贸n
            </span>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="join-overlay" *ngIf="!room && needsJoin">
  <div class="join-card">
    <h2>Unirse a la sala {{ roomCode }}</h2>
    <p class="join-subtitle">Ingresa tu nombre para continuar</p>
    <input
      type="text"
      [(ngModel)]="joinUsername"
      placeholder="Tu nombre"
      maxlength="20"
      (keyup.enter)="joinFromLink()"
    />
    <button class="btn btn-primary" [disabled]="isJoining" (click)="joinFromLink()">
      {{ isJoining ? 'Conectando...' : 'Unirse' }}
    </button>
    <button class="btn btn-secondary" [disabled]="isJoining" (click)="leaveRoom()">
      Volver
    </button>
  </div>
</div>

<div class="loading" *ngIf="!room && !needsJoin">
  <div class="spinner"></div>
  <p>Conectando a la sala...</p>
</div>
